# THIS  FILE IS PART OF THE NSC-TOOLS SUITE
# IT SHOULD NOT BE EDITED TO CONFIGURE THE SUITE
# INSTEAD, PLEASE FILE A BUG REPORT SO EVERYONE
# CAN ENJOY YOUR ENHANCEMENTS

cleanup() {
    echo "Unmounting the remote cache..."
    umount "$MOUNTPOINT/cache" 2&> /dev/null
    echo "Removing the mountpoint"
    rm -r "$MOUNTPOINT" 2&> /dev/null
}

mount_share() {
    mkdir -p "$MOUNTPOINT/cache" "$MOUNTPOINT/db" && echo "Creating mount directory structure..." &&
        /bin/ln -s "$MOUNTPOINT/cache/db/sync" "$MOUNTPOINT/db" && echo "Symlinking remote sync db..." &&
        /bin/ln -s "$LOCALDB" "$MOUNTPOINT/db" && echo "Symlinking local db..." &&
        echo "Mounting remote cache..." &&
        mount -t cifs "//$REPO_IP/$REPO_NAME" "$MOUNTPOINT/cache" -o user=none,password=none

    return $?
}

push_pkglist_if_neccessary() {
    if [ ! -d "$MOUNTPOINT" ]; then
        return
    fi

	comm -23 <(pacman -Qq|sort) <(pacman -Qmq|sort) > "/tmp/$HOSTNAME.pkglist"
    
    if ! diff -q /tmp/$HOSTNAME.pkglist "$MOUNTPOINT/cache/nsc/$HOSTNAME.pkglist" > /dev/null
    then
        echo "Copying a new package list to the server..."
        scp "/tmp/$HOSTNAME.pkglist" "$REPO_USER@$REPO_IP:nsc_dir_link"
    fi
    
    rm  "/tmp/$HOSTNAME.pkglist"
}

print_color_msg() {
    echo -e "\E[$MSG_COLOR m$@\E[0m"
}

# vim: ft=sh
